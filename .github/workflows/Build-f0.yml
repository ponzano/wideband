name: Build wideband firmware (f0_module)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'firmware/**'
      - '.github/workflows/build-wideband.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'firmware/**'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-arm-none-eabi binutils-arm-none-eabi \
            libnewlib-arm-none-eabi \
            python3 python3-pip \
            xxd libarchive-zip-perl
          if ! command -v crc32 >/dev/null; then
            echo "crc32 not found after install" >&2
            exit 1
          fi

      - name: Build wideband (f0_module)
        working-directory: firmware/boards/f0_module
        run: |
          set -euo pipefail
          ./build_wideband.sh
        env:
          MAKEFLAGS: "-j4"

      - name: Verify outputs
        run: |
          set -euo pipefail
          find firmware -maxdepth 3 -type f | sort
          find for_rusefi -maxdepth 1 -type f | sort
          test -f for_rusefi/wideband_image.h
          test -f for_rusefi/wideband_image_with_bl.bin
          test -f firmware/deliver/f0_module/wideband_image.h
          test -f firmware/deliver/f0_module/wideband_image_with_bl.bin

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wideband-f0_module
          path: |
            for_rusefi/wideband_image.h
            for_rusefi/wideband_image_with_bl.bin
            firmware/deliver/f0_module/wideband_image.h
            firmware/deliver/f0_module/wideband_image_with_bl.bin
          if-no-files-found: error
