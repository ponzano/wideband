name: Build wideband firmware (f0_module)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'firmware/**'
      - '.github/workflows/build-wideband.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'firmware/**'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-arm-none-eabi binutils-arm-none-eabi \
            libnewlib-arm-none-eabi \
            python3 python3-pip \
            xxd crc32
          # crc32 comes from the 'libarchive-zip-perl' package on Ubuntu
          # but many images have a 'crc32' from 'libarchive-tools' (bsdtar). If missing:
          if ! command -v crc32 >/dev/null; then
            sudo apt-get install -y libarchive-zip-perl
          fi

      # Optional: if you need a specific arm-none-eabi toolchain version, install via xpm or tarball here

      - name: Build wideband (f0_module)
        working-directory: firmware/boards/f0_module
        run: |
          set -euo pipefail
          ./build_wideband.sh
        env:
          # Example: override -j if needed
          MAKEFLAGS: "-j4"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wideband-f0_module
          path: |
            firmware/for_rusefi/wideband_image.h
            firmware/for_rusefi/wideband_image_with_bl.bin
            firmware/boards/f0_module/deliver/f0_module/wideband_image.h
            firmware/boards/f0_module/deliver/f0_module/wideband_image_with_bl.bin
          if-no-files-found: error
